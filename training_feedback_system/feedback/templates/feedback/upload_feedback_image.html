{% extends 'feedback/base.html' %}
{% block title %}Upload Feedback Image (OCR){% endblock %}
{% block content %}
<div class="container mt-5" style="max-width: 600px;">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Upload Feedback Image (OCR)</h4>
        </div>
        <div class="card-body">
            <form id="feedback-image-upload-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="id_session" class="form-label">Select Session *</label>
                    {{ form.session }}
                </div>
                <div class="mb-3">
                    <label for="id_image_file" class="form-label">Upload Feedback Form Image *</label>
                    <input type="file" name="image_file" accept="image/*" id="id_image_file" class="form-control" required />
                    <small class="text-muted">Supported formats: JPG, PNG</small>
                </div>
            </form>
            <div id="ocr-output" class="mt-3"></div>
            
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('feedback-image-upload-form');
                const fileInput = document.getElementById('id_image_file');
                const sessionInput = form.querySelector('select[name="session"]');
                const outputDiv = document.getElementById('ocr-output');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                function showLoading() {
                    outputDiv.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div>Scanning and extracting feedback, please wait...</div>
                            </div>
                        </div>`;
                }

                function showError(message, details = null) {
                    let html = `<div class="alert alert-danger">${message}</div>`;
                    if (details) {
                        html += `<details class="mt-2">
                            <summary class="text-muted" style="cursor: pointer;">Show Technical Details</summary>
                            <pre class="bg-light p-2 mt-2 small">${JSON.stringify(details, null, 2)}</pre>
                        </details>`;
                    }
                    outputDiv.innerHTML = html;
                }

                function showResult(data) {
                    console.log('Response:', data);  // For debugging
                    
                    if (!data.success) {
                        let errorHtml = `<div class="alert alert-danger">${data.error || 'Scan failed.'}</div>`;
                        
                        if (data.traceback) {
                            errorHtml += `<details class="mt-2">
                                <summary class="text-muted" style="cursor: pointer;">Show Error Details</summary>
                                <pre class="bg-light p-2 mt-2 small">${data.traceback}</pre>
                            </details>`;
                        }
                        
                        if (data.debug_info) {
                            errorHtml += `<details class="mt-2">
                                <summary class="text-muted" style="cursor: pointer;">Show Debug Information</summary>
                                <pre class="bg-light p-2 mt-2 small">${JSON.stringify(data.debug_info, null, 2)}</pre>
                            </details>`;
                        }
                        
                        outputDiv.innerHTML = errorHtml;
                        return;
                    }

                    let html = '<div class="alert alert-success"><b>Scan Result:</b></div>';
                    if (data.feedback && data.feedback.length > 0) {
                        html += `<pre class="bg-light p-3 mt-2">${JSON.stringify(data.feedback, null, 2)}</pre>`;
                    } else {
                        html += '<div class="alert alert-warning">No feedback data was extracted.</div>';
                    }
                    
                    if (data.debug_info) {
                        html += `<details class="mt-2">
                            <summary class="text-muted" style="cursor: pointer;">Show Debug Information</summary>
                            <pre class="bg-light p-2 mt-2 small">${JSON.stringify(data.debug_info, null, 2)}</pre>
                        </details>`;
                    }
                    
                    outputDiv.innerHTML = html;
                }

                async function uploadImage() {
                    if (fileInput.files.length === 0) return;
                    
                    if (!sessionInput.value) {
                        showError('Please select a session first');
                        fileInput.value = '';
                        return;
                    }

                    const formData = new FormData();
                    formData.append('image_file', fileInput.files[0]);
                    formData.append('session', sessionInput.value);

                    showLoading();

                    try {
                        const response = await fetch(window.location.href, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData,
                            credentials: 'same-origin'  // Important for CSRF
                        });

                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            showError('Server returned an invalid response', { 
                                response: text,
                                status: response.status,
                                contentType: contentType 
                            });
                            return;
                        }

                        const data = await response.json();
                        showResult(data);
                    } catch (error) {
                        console.error('Upload error:', error);  // For debugging
                        showError('Network or server error', { message: error.toString() });
                    }
                }

                // Handle file selection
                fileInput.addEventListener('change', uploadImage);
            });
            </script>

            {% if error_message %}
                <div class="alert alert-danger mt-3">{{ error_message }}</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
