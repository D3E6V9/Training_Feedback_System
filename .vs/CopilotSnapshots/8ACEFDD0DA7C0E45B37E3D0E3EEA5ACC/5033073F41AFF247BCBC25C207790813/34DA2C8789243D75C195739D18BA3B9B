from django.db import models
from django.contrib.auth.models import User
from django.core.validators import MinValueValidator, MaxValueValidator
import uuid

class Trainer(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField()
    phone = models.CharField(max_length=20, blank=True)
    specialization = models.CharField(max_length=200, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return self.name

    class Meta:
        ordering = ['name']

class TrainingSession(models.Model):
    session_title = models.CharField(max_length=200)
    trainer = models.ForeignKey(Trainer, on_delete=models.CASCADE)
    date = models.DateField()
    location = models.CharField(max_length=200, blank=True)
    duration_hours = models.DecimalField(max_digits=4, decimal_places=2, default=2.0)
    max_participants = models.PositiveIntegerField(default=30)
    created_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.session_title} - {self.trainer.name}"

    def get_feedback_count(self):
        return self.feedbackresponse_set.count()

    def get_average_rating(self):
        responses = self.feedbackresponse_set.all()
        if not responses:
            return 0
        
        total_ratings = 0
        count = 0
        for response in responses:
            ratings = [
                response.rating_1, response.rating_2, response.rating_3, 
                response.rating_4, response.rating_5, response.rating_6, 
                response.rating_7, response.rating_8
            ]
            total_ratings += sum(rating for rating in ratings if rating)
            count += len([rating for rating in ratings if rating])
        
        return round(total_ratings / count, 2) if count > 0 else 0

    class Meta:
        ordering = ['-date']

class FeedbackResponse(models.Model):
    session = models.ForeignKey(TrainingSession, on_delete=models.CASCADE)
    participant_name = models.CharField(max_length=100, blank=True, default='Anonymous')
    
    # 8 Rating Questions (1-5 scale)
    rating_1 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="The training met my expectations"
    )
    rating_2 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="I will be able to apply the knowledge learned"
    )
    rating_3 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="The content was organized and easy to follow"
    )
    rating_4 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="The trainer was knowledgeable"
    )
    rating_5 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="Training was relevant to my needs"
    )
    rating_6 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="Instructions were clear and understandable"
    )
    rating_7 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="Length and timing of training was sufficient"
    )
    rating_8 = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="Overall, the session was very good"
    )
    
    # Open-ended Questions
    key_learnings = models.TextField(help_text="What are the 3–5 key learnings from today's session?")
    missing_elements = models.TextField(
        blank=True, 
        help_text="In your opinion, what was missing in the session?"
    )
    
    # Meta
    submitted_at = models.DateTimeField(auto_now_add=True)
    ip_address = models.GenericIPAddressField(blank=True, null=True)

    def get_average_rating(self):
        ratings = [
            self.rating_1, self.rating_2, self.rating_3, self.rating_4,
            self.rating_5, self.rating_6, self.rating_7, self.rating_8
        ]
        return round(sum(ratings) / len(ratings), 2)

    def __str__(self):
        return f"Feedback for {self.session.session_title} by {self.participant_name}"

    class Meta:
        ordering = ['-submitted_at']

class FeedbackReport(models.Model):
    session = models.OneToOneField(TrainingSession, on_delete=models.CASCADE)
    generated_at = models.DateTimeField(auto_now_add=True)
    openai_analysis = models.TextField(blank=True)
    word_document = models.FileField(upload_to='reports/', blank=True)
    email_sent = models.BooleanField(default=False)
    email_sent_at = models.DateTimeField(blank=True, null=True)
    
    def __str__(self):
        return f"Report for {self.session.session_title}"

    class Meta:
        ordering = ['-generated_at'] 
