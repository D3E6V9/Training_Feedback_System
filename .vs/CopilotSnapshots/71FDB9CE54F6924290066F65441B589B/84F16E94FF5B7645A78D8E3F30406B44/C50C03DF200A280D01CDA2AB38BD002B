from django import forms
from django.core.exceptions import ValidationError
from crispy_forms.helper import FormHelper
from crispy_forms.layout import Layout, Submit, Field, Div
from .models import FeedbackResponse, Trainer, TrainingSession
import logging

logger = logging.getLogger(__name__)

class FeedbackForm(forms.ModelForm):
    RATING_CHOICES = [
        (5, '5 - Strongly Agree'),
        (4, '4 - Agree'),
        (3, '3 - Neutral'),
        (2, '2 - Disagree'),
        (1, '1 - Strongly Disagree'),
    ]

    rating_1 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="1. The training met my expectations"
    )
    rating_2 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="2. I will be able to apply the knowledge learned"
    )
    rating_3 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="3. The content was organized and easy to follow"
    )
    rating_4 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="4. The trainer was knowledgeable"
    )
    rating_5 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="5. Training was relevant to my needs"
    )
    rating_6 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="6. Instructions were clear and understandable"
    )
    rating_7 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="7. Length and timing of training was sufficient"
    )
    rating_8 = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.RadioSelect,
        label="8. Overall, the session was very good"
    )

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.helper = FormHelper()
        self.helper.form_method = 'post'
        self.helper.layout = Layout(
            Field('participant_name', css_class='form-control'),
            Div(
                Field('rating_1', template='feedback/rating_template.html'),
                Field('rating_2', template='feedback/rating_template.html'),
                Field('rating_3', template='feedback/rating_template.html'),
                Field('rating_4', template='feedback/rating_template.html'),
                Field('rating_5', template='feedback/rating_template.html'),
                Field('rating_6', template='feedback/rating_template.html'),
                Field('rating_7', template='feedback/rating_template.html'),
                Field('rating_8', template='feedback/rating_template.html'),
                css_class='ratings-container'
            ),
            Field('key_learnings', css_class='form-control'),
            Field('missing_elements', css_class='form-control'),
            Submit('submit', 'Submit Feedback', css_class='btn btn-primary mt-3')
        )

    class Meta:
        model = FeedbackResponse
        fields = [
            'participant_name', 'rating_1', 'rating_2', 'rating_3', 'rating_4',
            'rating_5', 'rating_6', 'rating_7', 'rating_8', 'key_learnings', 'missing_elements'
        ]
        widgets = {
            'participant_name': forms.TextInput(attrs={'placeholder': 'Enter your name (optional)', 'class': 'form-control'}),
            'key_learnings': forms.Textarea(attrs={
                'rows': 4, 
                'placeholder': 'Please list the main things you learned during this session...',
                'class': 'form-control'
            }),
            'missing_elements': forms.Textarea(attrs={
                'rows': 3, 
                'placeholder': 'Please share what you think could have been improved or added...',
                'class': 'form-control'
            }),
        }

    def clean(self):
        cleaned_data = super().clean()
        try:
            # Validate all ratings are present and within range
            for i in range(1, 9):
                rating_key = f'rating_{i}'
                rating = cleaned_data.get(rating_key)
                if rating is None:
                    raise ValidationError(f'{rating_key} is required')
                if not (1 <= int(rating) <= 5):
                    raise ValidationError(f'{rating_key} must be between 1 and 5')
        except Exception as e:
            logger.error(f"Form validation error: {str(e)}")
            raise
        return cleaned_data

class TrainerForm
